From: Werner Lemberg <wl@gnu.org>
Date: Mon, 19 Oct 2020 23:45:28 +0200
Subject: [sfnt] Fix heap buffer overflow (#59308).
Origin: https://git.savannah.gnu.org/cgit/freetype/freetype2.git/commit/?id=a3bab162b2ae616074c8877a04556932998aeacd
Bug-Debian: https://bugs.debian.org/972586
Bug-Debian-Security: https://security-tracker.debian.org/tracker/CVE-2020-15999

This is CVE-2020-15999.

* src/sfnt/pngshim.c (Load_SBit_Png): Test bitmap size earlier.
---
 ChangeLog          |  8 ++++++++
 src/sfnt/pngshim.c | 14 +++++++-------
 2 files changed, 15 insertions(+), 7 deletions(-)

Index: freetype-2.5.2/src/sfnt/pngshim.c
===================================================================
--- freetype-2.5.2.orig/src/sfnt/pngshim.c	2020-10-23 15:48:50.725001186 +0200
+++ freetype-2.5.2/src/sfnt/pngshim.c	2020-10-23 15:48:50.717000800 +0200
@@ -259,6 +259,12 @@
     {
       FT_Long  size;
 
+      /* reject too large bitmaps similarly to the rasterizer */
+      if ( imgHeight > 0x7FFF || imgWidth > 0x7FFF )
+      {
+        error = FT_THROW( Array_Too_Large );
+        goto DestroyExit;
+      }
 
       metrics->width  = (FT_Int)imgWidth;
       metrics->height = (FT_Int)imgHeight;
